---
name: Tekton Bundle Push
on:  # yamllint disable-line rule:truthy
  push:
    branches: ['main']
  workflow_dispatch:
env:
  IMAGE_REGISTRY: quay.io
  IMAGE_NAMESPACE: hacbs-release
  REGISTRY_USER: ${{ secrets.QUAY_ROBOT_USER }}
  REGISTRY_PASSWORD: ${{ secrets.QUAY_ROBOT_TOKEN }}
jobs:
  run-pipeline:
    name: Tekton Bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 2  # diff'ing the previous commit requires fetch depth=2
      - run: |
          mkdir -vp $HOME/.kube || true
          cat <<-EOF > $HOME/.kube/config
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              server: _
            name: _
          contexts:
          - context:
              cluster: _
            name: _
          current-context: _
          EOF
      - uses: jerop/tkn@v0.1.0
      - uses: redhat-actions/podman-login@v1
        with:
          username: ${{ env.REGISTRY_USER }}
          password: ${{ env.REGISTRY_PASSWORD }}
          registry: ${{ env.IMAGE_REGISTRY }}
      - run: |
          declare -A bundle_dirs
          while read file
          do
            [[ ${file%%/*} = \.* ]] && continue
            bundle_dirs["${file%%/*}"]+="${file##*/} "
          done < <(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})
          for BUNDLE_NAME in "${!bundle_dirs[@]}"
          do
            BUNDLE_FILES=()
            for file in $BUNDLE_NAME/*.y{,a}ml
            do
              [[ -e "$file" ]] || continue
              BUNDLE_FILES+=("$file")
            done
            printf -v bundle_files -- '-f %s ' ${BUNDLE_FILES[*]}
            printf -v image_tag_sha '%s/%s/%s:%s' \
              ${{ env.IMAGE_REGISTRY }} \
              ${{ env.IMAGE_NAMESPACE }} \
              "${BUNDLE_NAME}" \
              "${GITHUB_SHA:0:8}" ;
            printf -v image_tag_latest '%s/%s/%s:%s' \
              ${{ env.IMAGE_REGISTRY }} \
              ${{ env.IMAGE_NAMESPACE }} \
              "${BUNDLE_NAME}" \
              "latest" ;
            tkn bundle push ${bundle_files} $image_tag_sha ;
            tkn bundle push ${bundle_files} $image_tag_latest ;
          done
