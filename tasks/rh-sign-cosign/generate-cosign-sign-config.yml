# This file was generated by command:
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  annotations:
    tekton.dev/pipelines.minVersion: 0.12.1
    tekton.dev/tags: release
  labels:
    app.kubernetes.io/version: 1.0.0
  name: generate-cosign-sign-config
spec:
  description: |2
    generate configuration for sign-snapshot task.
  params:
  - description: 'signing config map name'
    name: config_map_name
    type: string
  results:
    - name: sig_key
      description: "Signing key"
    - name: quay_host
      description: "Quay host"
    - name: quay_user
      description: "Quay user"
    - name: quay_password
      description: "Quay password"
    - name: rekor_url
      description: "Rekor URL"
    - name: upload_tlog
      description: "Whether to upload TLog"
    - name: aws_default_region
      description: "AWS default region"
    - name: aws_access_key_id
      description: "AWS access key ID"
    - name: aws_secret_access_key
      description: "AWS secret access key"
  steps:
  - image: quay.io/jluza/signtractions:latest
    name: gather-signing-config-values
    env:
      - name: SIG_KEY
        valueFrom:
          configmapKeyRef:
            name: $(params.config_map_name)
            key: SIG_KEY
      - name: QUAY_HOST
        valueFrom:
          configmapKeyRef:
            name: $(params.config_map_name)
            key: QUAY_HOST
      - name: QUAY_USER
        valueFrom:
          configmapKeyRef:
            name: $(params.config_map_name)
            key: QUAY_USER
      - name: QUAY_PASSWORD
        valueFrom:
          configmapKeyRef:
            name: $(params.config_map_name)
            key: QUAY_PASSWORD
      - name: QUAY_PASSWORD
        valueFrom:
          configmapKeyRef:
            name: $(params.config_map_name)
            key: QUAY_PASSWORD
      - name: REKOR_URL
        valueFrom:
          configmapKeyRef:
            name: $(params.config_map_name)
            key: REKOR_URL
      - name: UPLOAD_TLOG
        valueFrom:
          configmapKeyRef:
            name: $(params.config_map_name)
            key: UPLOAD_TLOG
      - name: AWS_DEFAULT_REGION
        valueFrom:
          configmapKeyRef:
            name: $(params.config_map_name)
            key: AWS_DEFAULT_REGION
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          configmapKeyRef:
            name: $(params.config_map_name)
            key: AWS_ACCESS_KEY_ID
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          configmapKeyRef:
            name: $(params.config_map_name)
            key: AWS_SECRET_ACCESS_KEY
    script: |
      #!/usr/bin/bash --posix
      set -ex
      echo -n $SIG_KEY | tee $(results.sig_key.path)
      echo -n $QUAY_HOST | tee $(results.quay_host.path)
      echo -n $QUAY_USER | tee $(results.quay_user.path)
      echo -n $QUAY_PASSWORD | tee $(results.quay_password.path)
      echo -n $REKOR_URL | tee $(results.rekor_url.path)
      echo -n $UPLOAD_TLOG | tee $(results.upload_tlog.path)
      echo -n $AWS_DEFAULT_REGION | tee $(results.aws_default_region.path)
      echo -n $AWS_ACCESS_KEY_ID | tee $(results.aws_access_key_id.path)
      echo -n $AWS_SECRET_ACCESS_KEY | tee $(results.aws_secret_access_key.path)

      cat << EOF >> $(workspaces.outputs.path)/pubtools-sign.conf
      cosign_signer:
        rekor_url: $REKOR_URL
        upload_tlog: $UPLOAD_TLOG
        registry_user: $QUAY_USER
        registry_password: $QUAY_PASSWORD
        env_variables:
          AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION
          AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
          AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
      EOF
    workingDir: /
  workspaces:
  - name: outputs

