---
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-rh-sign-cosign-ml-tags-success
  annotations:
    test/assert-task-failure: "run-task"
spec:
  description: Test a scenario for successfull snapshot signing
  workspaces:
    - name: tests-workspace
  tasks:
    - name: setup
      workspaces:
        - name: outputs
          workspace: tests-workspace
      taskSpec:
        workspaces:
          - name: outputs
        steps:
          - name: setup-values
            image: quay.io/redhat-appstudio/release-service-utils:bc81bfed6062a386e48a76b252c6f33b52c411b0
            script: |
              #!/usr/bin/env sh
              set -eux
              cat > $(workspaces.outputs.path)/snapshot_spec.json << EOF
              {
                "application": "myapp",
                "components": [
                  {
                    "name": "comp0",
                    "containerImage": "registry.io/image0:tag1",
                    "repository": "quay.io/redhat-prod/myproduct----myrepo"
                  }
                ]
              }
              EOF
              cat > $(workspaces.outputs.path)/expected-signatures.yml << EOF
              data: |
                data:
                - arch: amd64
                  digest: sha256:2e8f38a0a8d2a450598430fa70c7f0b53aeec991e76c3e29c63add599b4ef7ee
                  reference: registry.io/image0:tag1
                  repo: image0
                  signing_key: test-signing-key
                - arch: arm64
                  digest: sha256:b3f9218fb5839763e62e52ee6567fe331aa1f3c644f9b6f232ff23959257acf9
                  reference: registry.io/image0:tag1
                  repo: image0
                  signing_key: test-signing-key
                - arch: arm
                  digest: sha256:496fb0ff2057c79254c9dc6ba999608a98219c5c93142569a547277c679e532c
                  reference: registry.io/image0:tag1
                  repo: image0
                  signing_key: test-signing-key
                - arch: ppc64le
                  digest: sha256:146ab6fa7ba3ab4d154b09c1c5522e4966ecd071bf23d1ba3df6c8b9fc33f8cb
                  reference: registry.io/image0:tag1
                  repo: image0
                  signing_key: test-signing-key
                - arch: s390x
                  digest: sha256:bbef1f46572d1f33a92b53b0ba0ed5a1d09dab7ffe64be1ae3ae66e76275eabd
                  reference: registry.io/image0:tag1
                  repo: image0
                  signing_key: test-signing-key
                - arch: multiarch
                  digest: sha256:c98fd05e5067c421f7f5469a6fe7193db54d27de73a29cfb4087c905bfc75466
                  reference: registry.io/image0:tag1
                  repo: image0
                  signing_key: test-signing-key
              name: o_sign_entries
              EOF
    - name: run-task
      taskRef:
        name: sign-snapshot
      workspaces:
        - name: outputs
          workspace: tests-workspace
      params:
        - name: r_signer_wrapper_cosign
          value: |-
            ---
              r:
                label: cosign_signer
                pre_push: false
                config_file: test-config-file
                settings: {}
                entry_point_requests:
                  - args: []
                    kwargs:
                      config_file: test-config-file
                      digest:
                        - sha256:2e8f38a0a8d2a450598430fa70c7f0b53aeec991e76c3e29c63add599b4ef7ee
                        - sha256:b3f9218fb5839763e62e52ee6567fe331aa1f3c644f9b6f232ff23959257acf9
                        - sha256:496fb0ff2057c79254c9dc6ba999608a98219c5c93142569a547277c679e532c
                        - sha256:146ab6fa7ba3ab4d154b09c1c5522e4966ecd071bf23d1ba3df6c8b9fc33f8cb
                        - sha256:bbef1f46572d1f33a92b53b0ba0ed5a1d09dab7ffe64be1ae3ae66e76275eabd
                        - sha256:c98fd05e5067c421f7f5469a6fe7193db54d27de73a29cfb4087c905bfc75466
                      reference:
                        - registry.io/image0:tag1
                        - registry.io/image0:tag1
                        - registry.io/image0:tag1
                        - registry.io/image0:tag1
                        - registry.io/image0:tag1
                        - registry.io/image0:tag1
                      signing_key: test-signing-key
                entry_point_returns:
                  - signer_result:
                      status: ok
        - name: r_dst_quay_client
          value: |-
            ---
              r:
                username: 'test'
                password: 'password'
                host: "quay.io"
                manifests:
                  "registry.io/image0:tag1":
                    "application/vnd.docker.distribution.manifest.list.v2+json": >
                        {
                        "schemaVersion": 2,
                        "mediaType": "application/vnd.docker.distribution.manifest.list.v2+json",
                        "manifests": [
                            {
                                "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
                                "size": 949,
                                "digest": "sha256:2e8f38a0a8d2a450598430fa70c7f0b53aeec991e76c3e29c63add599b4ef7ee",
                                "platform": {"architecture": "amd64", "os": "linux"}
                            },
                            {
                                "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
                                "size": 949,
                                "digest": "sha256:b3f9218fb5839763e62e52ee6567fe331aa1f3c644f9b6f232ff23959257acf9",
                                "platform": {"architecture": "arm64", "os": "linux"}
                            },
                            {
                                "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
                                "size": 949,
                                "digest": "sha256:496fb0ff2057c79254c9dc6ba999608a98219c5c93142569a547277c679e532c",
                                "platform": {"architecture": "arm", "os": "linux"}
                            },
                            {
                                "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
                                "size": 949,
                                "digest": "sha256:146ab6fa7ba3ab4d154b09c1c5522e4966ecd071bf23d1ba3df6c8b9fc33f8cb",
                                "platform": {"architecture": "ppc64le", "os": "linux"}
                            },
                            {
                                "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
                                "size": 949,
                                "digest": "sha256:bbef1f46572d1f33a92b53b0ba0ed5a1d09dab7ffe64be1ae3ae66e76275eabd",
                                "platform": {"architecture": "s390x", "os": "linux"}
                            }]}
            
        - name: i_snapshot_str
          value: |-
            ---
              data: ""
        - name: i_snapshot_file
          value: |-
            ---
              data: "$(workspaces.outputs.path)/snapshot_spec.json"
        - name: i_signing_key
          value: |-
            ---
              data: 'test-signing-key'
        - name: i_task_id
          value: |-
            ---
              data: 1
        - name: a_pool_size
          value: |-
            ---
              a: 5
        - name: a_executor_type
          value: |-
            ---
              a: THREAD
      runAfter:
        - setup
    - name: check-result
      workspaces:
        - name: outputs
          workspace: tests-workspace
      taskSpec:
        steps:
          - name: check-result
            image: quay.io/redhat-appstudio/release-service-utils:bc81bfed6062a386e48a76b252c6f33b52c411b0
            script: |
              #!/usr/bin/env python3
              import yaml
              expected = yaml.safe_load(open("$(workspaces.outputs.path)/expected-signatures.yml"))
              expected_data = yaml.safe_load(expected['data'])
              actual = yaml.safe_load(open("$(workspaces.outputs.path)/root::o_sign_entries"))
              actual_data = yaml.safe_load(actual['data'])
              print('expected')
              print(expected_data)
              print('actual')
              print('----')
              print(actual_data)
              assert expected_data == actual_data
              print("success")
      runAfter:
        - run-task

