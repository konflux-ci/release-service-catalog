---
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: make-repo-public
  labels:
    app.kubernetes.io/version: "0.1.0"
  annotations:
    tekton.dev/pipelines.minVersion: "0.12.1"
    tekton.dev/tags: release
spec:
  description: >-
    Tekton task that makes repositories public using quay.io API
  params:
    - name: dataPath
      type: string
      description: Path to the merged data JSON file generated by collect-data task
    - name: registrySecret
      type: string
      description: "The kube secret to use quay.io API, containing one key: token"
  workspaces:
    - name: data
      description: The workspace where the data json file resides
  steps:
    - name: make-repo-public
      image: quay.io/konflux-ci/release-service-utils:a5072c6da901bc9cf4d767da82e700784c7df981
      env:
        - name: REGISTRY_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.registrySecret)
              key: token
      script: |
        #!/usr/bin/env bash
        set -eux

        # Function to call quay.io to make a repository public
        # Parameters:
        # repository: full path to repo on quay.io, e.g. "myorg/myrepo"
        function make_repo_public() {
          set +x
          if curl -X POST \
            --fail-with-body --retry 3 \
            --header "Authorization: Bearer ${REGISTRY_TOKEN}" \
            --header 'Content-Type: application/json' \
            --data '{"visibility": "public"}' \
            "https://quay.io/api/v1/repository/${1}/changevisibility"
          then
            echo Success
          else
            echo "Error: Failed to make repo quay.io/${1} public."\
              "Make sure the secret $(params.registrySecret) contains"\
              " the \"token\" key with token that has permission to"\
              " Administer Repositories."
            exit 1
          fi
          set -x
        }

        DATA_FILE="$(workspaces.data.path)/$(params.dataPath)"
        if [ ! -f "${DATA_FILE}" ] ; then
            echo "No valid data file was provided."
            exit 1
        fi

        DEFAULT="$(jq -r '.mapping.defaults.public // false' "$DATA_FILE")"

        NUM_COMPONENTS=$(jq '.mapping.components | length' "$DATA_FILE")
        for ((i=0; i < NUM_COMPONENTS; i++)); do
          COMPONENT="$(jq -c ".mapping.components[$i]" "$DATA_FILE")"
          if [ "$(jq -r --arg default "$DEFAULT" '.public // $default' <<< "$COMPONENT")" = true ] ; then
            REPO="$(jq -r ".repository" <<< "$COMPONENT")"

            echo "Making repository $REPO public..."

            if [[ "$REPO" != quay.io/* ]]; then
              echo "Warning: Only quay.io repositories are supported. Skipping this repo."
              continue
            fi

            REPO=${REPO#quay.io/}
            REPO=${REPO%/} # Remove trailing slash just in case

            make_repo_public "$REPO"
          fi
        done
